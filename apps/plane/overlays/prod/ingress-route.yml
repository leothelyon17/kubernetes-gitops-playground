---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: plane-ingressroute
  namespace: plane-prod
spec:
  entryPoints:
    - websecure
  routes:
    # -------------------------
    # API routes (MUST win over "/")
    # -------------------------
    - match: Host(`plane-pm.home.nerdylyonsden.io`) && (PathPrefix(`/api`) || PathPrefix(`/auth`) || PathPrefix(`/graphql`) || PathPrefix(`/marketplace`))
      kind: Rule
      priority: 100
      middlewares:
      - name: plane-forwarded-https
      services:
        - name: plane-prod-api
          port: 8000

    # -------------------------
    # App micro-frontends
    # -------------------------
    - match: Host(`plane-pm.home.nerdylyonsden.io`) && PathPrefix(`/spaces`)
      kind: Rule
      priority: 90
      middlewares:
      - name: plane-forwarded-https
      services:
        - name: plane-prod-space
          port: 3000

    - match: Host(`plane-pm.home.nerdylyonsden.io`) && PathPrefix(`/god-mode`)
      kind: Rule
      priority: 90
      middlewares:
      - name: plane-forwarded-https
      services:
        - name: plane-prod-admin
          port: 3000

    - match: Host(`plane-pm.home.nerdylyonsden.io`) && PathPrefix(`/live`)
      kind: Rule
      priority: 90
      middlewares:
      - name: plane-forwarded-https
      services:
        - name: plane-prod-live
          port: 3000

    # -------------------------
    # Uploads (only if you use local MinIO behind Plane)
    # -------------------------
    - match: Host(`plane-pm.home.nerdylyonsden.io`) && PathPrefix(`/uploads`)
      kind: Rule
      priority: 80
      middlewares:
      - name: plane-forwarded-https
      services:
        - name: plane-prod-minio
          port: 9000

    # -------------------------
    # Catch-all frontend (MUST be last / lowest priority)
    # -------------------------
    - match: Host(`plane-pm.home.nerdylyonsden.io`) && PathPrefix(`/`)
      kind: Rule
      priority: 1
      middlewares:
      - name: plane-forwarded-https
      services:
        - name: plane-prod-web
          port: 3000

  tls:
    secretName: prod-apps-certificate-secret

